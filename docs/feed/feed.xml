<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom" xml:base="en">
	<title>Recompiled</title>
	<subtitle>I write about compilers and JavaScript</subtitle>
	<link href="https://www.recompiled.dev/feed/feed.xml" rel="self"/>
	<link href="https://www.recompiled.dev/"/>
	<updated>2024-02-22T16:45:37Z</updated>
	<id>https://www.recompiled.dev</id>
	<author>
		<name>Sathya Gunasekran</name>
		<email>gsathya.ceg@gmail.com</email>
	</author>
	
	<entry>
		<title>Compiler Theory and Reactivity</title>
		<link href="https://www.recompiled.dev/blog/ssa/"/>
		<updated>2024-02-22T16:45:37Z</updated>
		<id>https://www.recompiled.dev/blog/ssa/</id>
		<content type="html">&lt;p&gt;The React compiler implements numerous traditional compiler transformations,
that are generally not accessible without having some background in compiler
theory. In this post, I&#39;ll try to provide a more accessible explaination of a compiler pass called Static Single
Assignment form (SSA) using examples.&lt;/p&gt;
&lt;div class=&quot;message-box&quot;&gt;
	&lt;p&gt;&lt;em&gt;If you&#39;re wondering what the React compiler is, I recommend reading our recent &lt;a href=&quot;https://react.dev/blog/2024/02/15/react-labs-what-we-have-been-working-on-february-2024#react-compiler&quot;&gt;update post&lt;/a&gt; for some background.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Consider this simple React component:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; colours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; colours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Item styles&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;styles&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;Item&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can easily memoize it like this:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;props&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; $ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useMemoCache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; colours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; props&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; t0&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; colours&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		t0 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; colours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

		$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; colours&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; t0&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		t0 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; t0&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Item styles&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;styles&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The compiler can easily track the &lt;code&gt;styles&lt;/code&gt; object being created and passed down as props.&lt;/p&gt;
&lt;div class=&quot;message-box&quot;&gt;
	&lt;p&gt;&lt;em&gt;Don&#39;t worry too much about the useMemoCache hook, it&#39;s an internal API used by the compiler to cache values. Think of `$` as an array.&lt;/em&gt;&lt;/p&gt;
  &lt;p&gt;&lt;em&gt;The React Compiler can memoize JSX too, but I&#39;m leaving it out in this post for brevity.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Now, let&#39;s say you want to refactor the styles based on a condition.&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; colours&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; hover&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; hoverColours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; styles&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;hover&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; colours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;colours&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; hoverColours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Item styles&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;styles&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;Item&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Memoizing the &lt;code&gt; styles&lt;/code&gt; object becomes a bit more challenging for the compiler because it&#39;s no longer a single statement. It&#39;s spread across several statements, and there&#39;s control flow involved -- styles is created in both the &lt;code&gt;if&lt;/code&gt;and&lt;code&gt;else&lt;/code&gt; block.&lt;/p&gt;
&lt;p&gt;The compiler can still track styles creation across both blocks and memoize it like this:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;props&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; $ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useMemoCache&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; hover&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; colours&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; hoverColours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; props&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; styles&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; hover &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; colours &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; hoverColours&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;hover&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; colours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;colours&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; hoverColours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

		$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hover&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; colours&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hoverColours&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; styles&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Item styles&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;styles&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This works, but it&#39;s not ideal because we&#39;d invalidate the memoized value if any of &lt;code&gt;hover&lt;/code&gt;, &lt;code&gt;colours&lt;/code&gt; or &lt;code&gt;hoverColours&lt;/code&gt; changes. It&#39;s too &lt;em&gt;coarse grained&lt;/em&gt;. Can we do better?&lt;/p&gt;
&lt;h3 id=&quot;track-values-not-variables&quot; tabindex=&quot;-1&quot;&gt;Track values, not variables &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/ssa/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;One core intuition is that we&#39;d memoize the values in the &lt;code&gt;if&lt;/code&gt; block separately from the &lt;code&gt;else&lt;/code&gt; block. They are separate &lt;em&gt;values&lt;/em&gt; (separate &lt;em&gt;objects&lt;/em&gt;), just being referenced by the same variable identifier (&lt;code&gt;styles&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Consider our previously example, but slightly modified to track the value separately by giving them different identifiers:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; styles&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;hover&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  t0 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; colours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;              &lt;span class=&quot;token comment&quot;&gt;// &amp;lt;-- separate value&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  t1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;colours&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; hoverColours&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// &amp;lt;-- separate value&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;choose&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;t0 or t1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now, it&#39;s pretty clear that we can memoize &lt;code&gt;t0&lt;/code&gt; and &lt;code&gt;t1&lt;/code&gt; separately. You&#39;ve also realized that we need to choose between &lt;code&gt;t0&lt;/code&gt; and &lt;code&gt;t1&lt;/code&gt; and assign it correctly to &lt;code&gt;styles&lt;/code&gt;, but let&#39;s ignore that for now.&lt;/p&gt;
&lt;p&gt;The compiler can memoize the values in their respective blocks:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;hover&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; colours&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		t0 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			colours&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; colours&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; t0&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		t0 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; hoverColours&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		t1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token literal-property property&quot;&gt;colours&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; hoverColours&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hoverColours&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; t1&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		t1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;choose&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;t0 or t1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This is more &lt;em&gt;fine grained&lt;/em&gt; than the previous example.&lt;/p&gt;
&lt;h3 id=&quot;where-s-the-complexity&quot; tabindex=&quot;-1&quot;&gt;Where&#39;s the complexity? &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/ssa/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;But, wait, we&#39;re just memoizing a value in the scope it was created, what&#39;s so hard about it?&lt;/p&gt;
&lt;p&gt;Well, let&#39;s consider another example:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; colours&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; hover&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; hoverColours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; styles&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;hover&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; colours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;colours&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; hoverColours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	styles&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;height &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;large&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// &amp;lt;-- modifying styles object&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Item styles&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;styles&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;Item&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In the above example, we modify the &lt;code&gt;styles&lt;/code&gt; object after the &lt;code&gt;if-else&lt;/code&gt; block by
adding a new property named &lt;code&gt;height&lt;/code&gt;. It&#39;s no longer safe to memoize the values
inside the &lt;code&gt;if&lt;/code&gt;-block and &lt;code&gt;else&lt;/code&gt;-block separately.&lt;/p&gt;
&lt;p&gt;We can&#39;t modify a value after it&#39;s memoized. Not because it&#39;s sub-optimal performance-wise, but because it leads to incorrect behavior during re-rendering. Take a minute to think about how this behavior can manifest in practice.&lt;/p&gt;
&lt;p&gt;We need a way to track the values as they &lt;em&gt;flow&lt;/em&gt;, not just simply memoize it in the scope they are created.&lt;/p&gt;
&lt;div class=&quot;message-box&quot;&gt;
 &lt;p&gt;&lt;em&gt;One could argue that you shouldn&#39;t be writing code like this. But, local mutations are very natural in JavaScript and there&#39;s plenty of React code written like this that we need to compile efficiently.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;h3 id=&quot;track-the-flow&quot; tabindex=&quot;-1&quot;&gt;Track the flow &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/ssa/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Remember the &amp;quot;&lt;code&gt;choose&lt;/code&gt;&amp;quot; function, we ignored earlier? This lets the compiler track the values as they flow across if-else block!&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hover&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  t0 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; colours &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  t1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;colours&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; hoverColours&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;choose&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;t0 or t1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// &amp;lt;-- tracks values after control flow&lt;/span&gt;
styles&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;height &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&#39;large&#39;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now, the code (or to be precise, the compiler&#39;s &lt;a href=&quot;https://en.wikipedia.org/wiki/Intermediate_representation&quot;&gt;intermediate representation&lt;/a&gt;) tells the compiler that &lt;code&gt;styles&lt;/code&gt; is either &lt;code&gt;t0&lt;/code&gt; or &lt;code&gt;t1&lt;/code&gt; and modifying &lt;code&gt;styles&lt;/code&gt; is equivalent to modifying the values &lt;code&gt;t0&lt;/code&gt; and &lt;code&gt;t1&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The compiler can now infer that the &lt;code&gt;styles&lt;/code&gt; can only be memoized at a coarser level like this:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; hover &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; colours &lt;span class=&quot;token operator&quot;&gt;||&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!==&lt;/span&gt; hoverColours&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;hover&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			colours&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;token literal-property property&quot;&gt;colours&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; hoverColours&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
		&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

	styles&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;height &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;large&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hover&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; colours&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hoverColours&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	$&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; styles&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	styles &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; $&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;compiler-theory&quot; tabindex=&quot;-1&quot;&gt;Compiler theory &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/ssa/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;To recap, we&#39;ve talked about tracking values separately with temporary identifiers and tracking the flow of values across control flow with a &amp;quot;choose&amp;quot; function.&lt;/p&gt;
&lt;p&gt;Interestingly, a classical compiler transformation called &lt;a href=&quot;https://en.wikipedia.org/wiki/Static_single-assignment_form&quot;&gt;Static single-assignment form&lt;/a&gt; (SSA) does exactly this! Tracking new values and re-assignments by creating a new temporary value is the core part of the SSA transform. The &amp;quot;&lt;em&gt;choose&lt;/em&gt;&amp;quot; function we talked about earlier is simply the &amp;quot;&lt;em&gt;phi&lt;/em&gt;&amp;quot; (Φ) function defined in the SSA form.&lt;/p&gt;
&lt;p&gt;The exact SSA transformation that the React compiler uses is from the excellent &lt;a href=&quot;https://c9x.me/compile/bib/braun13cc.pdf&quot;&gt;Simple and Efficient Construction of Static Single
Assignment Form&lt;/a&gt; paper.&lt;/p&gt;
&lt;p&gt;If you&#39;re curious to read more about compiler theory in the React compiler, take
a look at the &lt;a href=&quot;https://www.recompiled.dev/tags/forget/&quot;&gt;other tagged posts&lt;/a&gt;.&lt;/p&gt;
</content>
	</entry>
	
	<entry>
		<title>Alias analysis in React Compiler</title>
		<link href="https://www.recompiled.dev/blog/alias-analysis/"/>
		<updated>2024-01-22T11:45:30Z</updated>
		<id>https://www.recompiled.dev/blog/alias-analysis/</id>
		<content type="html">&lt;div class=&quot;message-box&quot;&gt;
	&lt;p&gt;&lt;em&gt;This post was originally published as a comment on the &lt;a href=&quot;https://www.reddit.com/r/reactjs/&quot;&gt;r/reactjs&lt;/a&gt; subreddit.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Forget supports almost all of the JavaScript language including all of it&#39;s idiosyncrasies. Forget is backwards compatible, so we have to work with existing code and not introduce new constraints -- this makes it a lot harder.&lt;/p&gt;
&lt;div class=&quot;message-box&quot;&gt;
	&lt;p&gt;&lt;em&gt;&lt;a href=&quot;https://react.dev/blog/2023/03/22/react-labs-what-we-have-been-working-on-march-2023#react-optimizing-compiler&quot;&gt;Forget&lt;/a&gt; was the code name for the React Compiler.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;One concrete example that looks simple enough but is actually really tricky to get right is aliasing, consider this example:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Foo x&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This seems simple enough to memoize with a compiler, the output should be something like this:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useMemo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Foo x&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The entire computation of &lt;code&gt;x&lt;/code&gt; is wrapped in a &lt;code&gt;useMemo&lt;/code&gt; and cached. Simple enough.&lt;/p&gt;
&lt;p&gt;What happens if you alias &lt;code&gt;x&lt;/code&gt; to some other variable?&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	y&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Foo x&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now, it&#39;s longer enough to simply memoize the computation of x separately like we did previously:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;// incorrect&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useMemo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useMemo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		y&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Foo x&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id=&quot;memoization-must-be-correct&quot; tabindex=&quot;-1&quot;&gt;Memoization must be correct &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/alias-analysis/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Note that the second example with the two memos is incorrect not because it&#39;s
suboptimal, but because it is logically incorrect. If you re-render the component with the same &lt;code&gt;a&lt;/code&gt; but different &lt;code&gt;b&lt;/code&gt;, then &lt;code&gt;x&lt;/code&gt; will be &lt;code&gt;[a,b,b]&lt;/code&gt; not &lt;code&gt;[a, b]&lt;/code&gt; as you might expect, leading to bugs.&lt;/p&gt;
&lt;p&gt;This is why it&#39;s all or nothing -- either we compile this correctly or skip compiling this component entirely.&lt;/p&gt;
&lt;p&gt;If there are too many bailouts then Forget is not very useful, so it&#39;s a careful balance that we&#39;re trying to get right by experimenting internally at Meta with various projects.&lt;/p&gt;
&lt;p&gt;The correct way to memoize this is to group the computation together:&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;Component&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;useMemo&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

		&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		y&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;push&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;b&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; y&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;a&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; b&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;Foo x&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;x&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This is already bit trickier than without aliasing, but this is still just straight line code. Imagine if we had control flow in between, or if this escapes to an object or some random function call? It gets much trickier. Forget can&#39;t simply bail out and refuse to compile this case as we want to be backwards compatible.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Alias_analysis&quot;&gt;Alias analysis&lt;/a&gt; on it&#39;s own is a
huge topic in compiler analysis. There&#39;s several other bits of compiler analysis
like this in Forget to make it work with vanilla JavaScript.&lt;/p&gt;
</content>
	</entry>
	
	<entry>
		<title>Side effecting a deopt</title>
		<link href="https://www.recompiled.dev/blog/deopt/"/>
		<updated>2023-09-19T13:33:37Z</updated>
		<id>https://www.recompiled.dev/blog/deopt/</id>
		<content type="html">&lt;p&gt;All popular JavaScript engines ship with optimising compilers (often, several
optimising compilers). As a consequence of &lt;em&gt;speculatively&lt;/em&gt; optimising a
JavaScript function, some of these speculations might get invalidated causing a
JavaScript function to be de-optimised back to (potentially) slower code.&lt;/p&gt;
&lt;p&gt;I had an interesting chat with a &lt;a href=&quot;https://twitter.com/zmofei&quot;&gt;colleague&lt;/a&gt; about the curious case of functions
deoptimising &lt;em&gt;without&lt;/em&gt; being invoked. While prepping for a &lt;a href=&quot;https://www.reactindia.io/speakers/sathya-gunasekaran&quot;&gt;talk&lt;/a&gt;, I got sidetracked and wrote this post.&lt;/p&gt;
&lt;h2 id=&quot;the-playground&quot; tabindex=&quot;-1&quot;&gt;The playground &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/deopt/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Let&#39;s look at a simple &lt;code&gt;load&lt;/code&gt; function that loads a known property from an object and returns it.&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;foo&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now, let&#39;s run this &lt;code&gt;load&lt;/code&gt; in a loop to trigger our friendly optimising compilers.&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; sum &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;10e6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i&lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		sum &lt;span class=&quot;token operator&quot;&gt;+=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;load&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; sum&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token function&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// optimise `load`&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Sure enough, v8 spews logging to confirm.&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;❯ ~/.jsvu/v8-debug --trace-opt test.js &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; load
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;marking &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;JSFunction load &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; optimization to MAGLEV&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;compiling method &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;JSFunction load&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;target MAGLEV&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;completed compiling &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;JSFunction load&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;target MAGLEV&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;div class=&quot;message-box&quot;&gt;
	&lt;p&gt;v8 has &lt;a href=&quot;https://blog.chromium.org/2023/06/how-chrome-achieved-high-scores-on.html&quot;&gt;several tiers of optimising compilers&lt;/a&gt;, we&#39;re only looking at Maglev code here as Turbofan simply inlines &lt;code&gt;load&lt;/code&gt; into &lt;code&gt;bench&lt;/code&gt;, which isn&#39;t very interesting for our purposes.&lt;/p&gt;
&lt;/div&gt;
&lt;h2 id=&quot;side-effecting-a-deopt&quot; tabindex=&quot;-1&quot;&gt;Side effecting a deopt &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/deopt/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Now that we&#39;ve got our playground setup, let&#39;s try to side effect a deopt by updating the value of &lt;code&gt;foo&lt;/code&gt;:&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// optimise `load`&lt;/span&gt;

x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;foo &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// update value of &#39;foo&#39;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Does this cause a deopt?&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;❯ ~/.jsvu/v8-debug --trace-deopt test.js &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; load
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;marking dependent code &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;load&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; deoptimization, reason: code dependencies&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Yes!&lt;/p&gt;
&lt;p&gt;There&#39;s a fair amount of information online on how &lt;a href=&quot;https://mathiasbynens.be/notes/shapes-ics&quot;&gt;hidden classes transitions&lt;/a&gt; cause inline caches to become polymorphic, but this is different. We haven&#39;t changed the hidden class of &lt;code&gt;x&lt;/code&gt; -- we&#39;ve only updated the value of an existing property.&lt;/p&gt;
&lt;p&gt;Let&#39;s dig into the generated code to see what&#39;s happening here.&lt;/p&gt;
&lt;pre class=&quot;language-armasm&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-armasm&quot;&gt;...
&lt;span class=&quot;token number&quot;&gt;0x280008150&lt;/span&gt;   &lt;span class=&quot;token number&quot;&gt;130&lt;/span&gt;  d2800040       movz x0&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0x2&lt;/span&gt;
...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Looks like v8 has completely inlined the property load, and replaced it with the value of the property!&lt;/p&gt;
&lt;div class=&quot;message-box&quot;&gt;
	&lt;p&gt;The value is &lt;code&gt;0x2&lt;/code&gt;, and not &lt;code&gt;0x1&lt;/code&gt; because it&#39;s been &lt;a href=&quot;https://en.wikipedia.org/wiki/Tagged_pointer&quot;&gt;tagged&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Alright, the deopt is starting to make sense because the optimised code simply returns the old value, not the new one. To protect against incorrect code, v8 has installed a dependency on the value of the &lt;code&gt;foo&lt;/code&gt; property and triggers a deopt when the dependency is invalidated.&lt;/p&gt;
&lt;p&gt;Wouldn&#39;t it be better if v8 just loaded the property at runtime, rather than inlining the value of the property?&lt;/p&gt;
&lt;p&gt;Let&#39;s ask v8 to re-optimise &lt;code&gt;load&lt;/code&gt;, after changing the value of &lt;code&gt;foo&lt;/code&gt;.&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// optimise load&lt;/span&gt;

x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;foo &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;re-optimising load&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The optimised code looks different now!&lt;/p&gt;
&lt;pre class=&quot;language-armasm&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-armasm&quot;&gt;...
&lt;span class=&quot;token number&quot;&gt;0x28001bfbc&lt;/span&gt;    fc  &lt;span class=&quot;token number&quot;&gt;580008e0&lt;/span&gt;       ldr x0&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; pc&lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;284&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;addr &lt;span class=&quot;token number&quot;&gt;0x000000028001c0d8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;   &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;: LoadTaggedField&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;0xc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; decompressed&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
...&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;v8 has learnt that this value isn&#39;t a constant, and it&#39;s not a good idea to
inline the value directly. Of course, inlining the value is strictly better
because it&#39;s faster, but only when value doesn&#39;t change. Otherwise we&#39;re going
to be stuck in a loop deoptimising and re-optimising.&lt;/p&gt;
&lt;p&gt;To double check, let&#39;s change the value once again.&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// optimise `load`&lt;/span&gt;

x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;foo &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// causes a deopt&lt;/span&gt;
console&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;log&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;re-optimising load&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;foo &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// another deopt?&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Does this deopt now?&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;❯ ~/.jsvu/v8-debug --trace-deopt test.js &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; load
deoptimising load
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;marking dependent code &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;load&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; deoptimization, reason: code dependencies&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
re-optimising load&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;No! v8 simply loads the property at runtime.&lt;/p&gt;
&lt;h2 id=&quot;expandos-considered-harmful&quot; tabindex=&quot;-1&quot;&gt;Expandos considered harmful &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/deopt/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The general JS performance tip is to not change the shape of an object after it&#39;s constructed. This is pretty good advice, and it&#39;s mostly given in the context of not &lt;a href=&quot;https://mrale.ph/blog/2015/01/11/whats-up-with-monomorphism.html&quot;&gt;polluting inline caches leading to poly/megamorphic caches&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;There&#39;s another reason that&#39;s often overlooked. Changing a hidden class can cause deopts.&lt;/p&gt;
&lt;p&gt;Let&#39;s go back to our playground.&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// optimise `load`&lt;/span&gt;

x&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;__expando &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// hidden class transition&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Notice how after adding the &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Glossary/Expando&quot;&gt;expando&lt;/a&gt;, we haven&#39;t invoked &lt;code&gt;load&lt;/code&gt; nor have we changed the value of &lt;code&gt;foo&lt;/code&gt;. Does this still cause a deopt?&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;❯ ~/.jsvu/v8-debug --trace-deopt test.js &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; load
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;marking dependent code &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;load&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; deoptimization, reason: code dependencies&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Sure enough. This is because we&#39;ve not only got a dependency on the value of the property, but also on the hidden class of the object.&lt;/p&gt;
&lt;p&gt;Let&#39;s look at slightly more &lt;s&gt;terrifying&lt;/s&gt; baffling example.&lt;/p&gt;
&lt;pre class=&quot;language-javascript&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-javascript&quot;&gt;&lt;span class=&quot;token function&quot;&gt;bench&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// optimise `load`&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; y &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token literal-property property&quot;&gt;foo&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
y&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;__expando &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We&#39;ve created a new object &lt;code&gt;y&lt;/code&gt; that does not share anything with &lt;code&gt;x&lt;/code&gt; (other than the builtin object prototype). We&#39;re not changing anything in the prototype of &lt;code&gt;y&lt;/code&gt; or &lt;code&gt;x&lt;/code&gt;, not updating &lt;code&gt;x&lt;/code&gt;, and not calling &lt;code&gt;load&lt;/code&gt;. There can&#39;t be any hidden class transitions in &lt;code&gt;x&lt;/code&gt;, so this shouldn&#39;t deopt, right?&lt;/p&gt;
&lt;pre class=&quot;language-bash&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-bash&quot;&gt;❯ ~/.jsvu/v8-debug --trace-deopt test.js &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;grep&lt;/span&gt; load
&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;marking dependent code &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt;load&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; deoptimization, reason: code dependencies&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This still deopts!&lt;/p&gt;
&lt;p&gt;I &lt;em&gt;lied&lt;/em&gt; when I said &lt;code&gt;x&lt;/code&gt; and &lt;code&gt;y&lt;/code&gt; don&#39;t share anything -- they share the same
&lt;a href=&quot;https://v8.dev/docs/hidden-classes&quot;&gt;hidden class&lt;/a&gt;! Adding an expando on &lt;code&gt;y&lt;/code&gt;
causes the shared hidden class to become unstable. The optimised code not only
depends on the value of the property and the hidden class, but also on the
&lt;em&gt;stability&lt;/em&gt; of the hidden class.&lt;/p&gt;
&lt;p&gt;But, why does the stability matter? The answer to any question in the v8 codebase is
simply -- &lt;em&gt;performance&lt;/em&gt; -- stable maps help generate better, more optimised
code. Seth goes into more detail about stable maps
&lt;a href=&quot;https://www.mail-archive.com/v8-dev@googlegroups.com/msg160069.html&quot;&gt;here&lt;/a&gt;, if
you&#39;re curious.&lt;/p&gt;
&lt;h2 id=&quot;takeaways&quot; tabindex=&quot;-1&quot;&gt;Takeaways &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/deopt/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;There&#39;s a whole slew of &lt;a href=&quot;https://source.chromium.org/chromium/chromium/src/+/main:v8/src/compiler/compilation-dependencies.cc;l=22-41;drc=a6bdc8f2993883fc55eb9cb0945694299b056675&quot;&gt;other
reasons&lt;/a&gt;
that could side effect a deopt. v8 calls
this category of deopts as &lt;em&gt;lazy&lt;/em&gt; deopts (as opposed to &lt;em&gt;eager deopts&lt;/em&gt;).&lt;/p&gt;
&lt;p&gt;I don&#39;t think this is necessarily a reason to entirely stop using expandos and
switch to using WeakMaps -- WeakMaps come with other tradeoffs.&lt;/p&gt;
&lt;p&gt;The best JS performance tip is to write code that expresses intent clearly and let the engine optimise it.&lt;/p&gt;
</content>
	</entry>
	
	<entry>
		<title>Internationalization APIs in V8</title>
		<link href="https://www.recompiled.dev/blog/intl/"/>
		<updated>2019-04-25T16:45:37Z</updated>
		<id>https://www.recompiled.dev/blog/intl/</id>
		<content type="html">&lt;div class=&quot;message-box&quot;&gt;
	&lt;p&gt;&lt;em&gt;This post was originally published on the &lt;a href=&quot;https://v8.dev/blog/intl&quot;&gt;V8 blog&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;https://tc39.es/ecma402/&quot;&gt;The ECMAScript Internationalization API Specification&lt;/a&gt; (ECMA-402, or &lt;code&gt;Intl&lt;/code&gt;) provides key locale-specific functionality such as date formatting, number formatting, plural form selection, and collation. The Chrome V8 and Google Internationalization teams have been collaborating on adding features to V8’s ECMA-402 implementation, while cleaning up technical debt and improving performance and interoperability with other browsers.&lt;/p&gt;
&lt;h2 id=&quot;underlying-architectural-improvements&quot; tabindex=&quot;-1&quot;&gt;Underlying architectural improvements &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/intl/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Initially the ECMA-402 spec was implemented mostly in JavaScript using V8-extensions and lived outside the V8 codebase. Using the external Extension API meant that several of V8’s internally used APIs for type checking, lifetime management of external C++ objects and internal private data storage couldn’t be used. As part of improving startup performance, this implementation was later moved in to the V8 codebase to enable &lt;a href=&quot;https://www.recompiled.dev/blog/custom-startup-snapshots&quot;&gt;snapshotting&lt;/a&gt; of these builtins.&lt;/p&gt;
&lt;p&gt;V8 uses specialized &lt;code&gt;JSObject&lt;/code&gt;s with custom &lt;a href=&quot;https://mathiasbynens.be/notes/shapes-ics&quot;&gt;shapes (hidden classes)&lt;/a&gt; to describe built-in JavaScript objects specified by ECMAScript (like &lt;code&gt;Promise&lt;/code&gt;s, &lt;code&gt;Map&lt;/code&gt;s, &lt;code&gt;Set&lt;/code&gt;s, etc). With this approach, V8 can pre-allocate the required number of internal slots and generate fast accesses to these, rather than grow the object one property at a time leading to slower performance and worse memory usage.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;Intl&lt;/code&gt; implementation was not modeled after such an architecture, as a consequence of the historic split. Instead, all the built-in JavaScript objects as specified by the Internationalization spec (like &lt;code&gt;NumberFormat&lt;/code&gt;, &lt;code&gt;DateTimeFormat&lt;/code&gt;) were generic &lt;code&gt;JSObject&lt;/code&gt;s that had to transition through several property additions for their internal slots.&lt;/p&gt;
&lt;p&gt;Another artifact of not having a specialized &lt;code&gt;JSObject&lt;/code&gt;s was that type checking was now more complex. The type information was stored under a private symbol and type-checked on both the JS and C++ side using expensive property access, rather than just looking up its shape.&lt;/p&gt;
&lt;h3 id=&quot;modernizing-the-codebase&quot; tabindex=&quot;-1&quot;&gt;Modernizing the codebase &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/intl/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;With the current move away from writing self-hosted builtins in V8, it made sense to use this opportunity to modernize the ECMA402 implementation.&lt;/p&gt;
&lt;h3 id=&quot;moving-away-from-self-hosted-js&quot; tabindex=&quot;-1&quot;&gt;Moving away from self-hosted JS &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/intl/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;Although self-hosting lends itself to concise and readable code, the frequent usage of slow runtime calls to access ICU APIs led to performance issues. As a result, a lot of ICU functionality was duplicated in JavaScript to reduce the number of such runtime calls.&lt;/p&gt;
&lt;p&gt;By rewriting the builtins in C++, it became much faster to access the ICU APIs as there is no runtime call overhead now.&lt;/p&gt;
&lt;h3 id=&quot;improving-icu&quot; tabindex=&quot;-1&quot;&gt;Improving ICU &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/intl/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;ICU is a set of C/C++ libraries used by a large set of applications, including all the major JavaScript engines, for providing Unicode and globalization support. As part of switching &lt;code&gt;Intl&lt;/code&gt; to ICU in V8’s implementation, we &lt;a href=&quot;https://unicode-org.atlassian.net/browse/ICU-20140&quot;&gt;found&lt;/a&gt; &lt;a href=&quot;https://unicode-org.atlassian.net/browse/ICU-9562&quot;&gt;and&lt;/a&gt; &lt;a href=&quot;https://unicode-org.atlassian.net/browse/ICU-20098&quot;&gt;fixed&lt;/a&gt; several ICU bugs.&lt;/p&gt;
&lt;p&gt;As part of implementing new proposals such as &lt;a href=&quot;https://www.recompiled.dev/features/intl-relativetimeformat&quot;&gt;&lt;code&gt;Intl.RelativeTimeFormat&lt;/code&gt;&lt;/a&gt;, &lt;a href=&quot;https://www.recompiled.dev/features/intl-listformat&quot;&gt;&lt;code&gt;Intl.ListFormat&lt;/code&gt;&lt;/a&gt; and &lt;code&gt;Intl.Locale&lt;/code&gt;, we’ve extended ICU by adding &lt;a href=&quot;https://unicode-org.atlassian.net/browse/ICU-13256&quot;&gt;several&lt;/a&gt; &lt;a href=&quot;https://unicode-org.atlassian.net/browse/ICU-20121&quot;&gt;new&lt;/a&gt; &lt;a href=&quot;https://unicode-org.atlassian.net/browse/ICU-20342&quot;&gt;APIs&lt;/a&gt; to support these new ECMAScript proposals.&lt;/p&gt;
&lt;p&gt;All of these additions help other JavaScript engines implement these proposals quicker now, pushing the web forward! For example, development is in progress in Firefox on implementing several new &lt;code&gt;Intl&lt;/code&gt; APIs based on our ICU work.&lt;/p&gt;
&lt;h2 id=&quot;performance&quot; tabindex=&quot;-1&quot;&gt;Performance &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/intl/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As a result of this work, we improved the performance of the Internationalization API by optimizing several fast paths and caching the initialization of the various &lt;code&gt;Intl&lt;/code&gt; objects and the &lt;code&gt;toLocaleString&lt;/code&gt; methods on &lt;code&gt;Number.prototype&lt;/code&gt;, &lt;code&gt;Date.prototype&lt;/code&gt;, and &lt;code&gt;String.prototype&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;For example, creating a new &lt;code&gt;Intl.NumberFormat&lt;/code&gt; object became around 24× faster.&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://www.recompiled.dev/img/1oz8K5m7ve-713.avif 713w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://www.recompiled.dev/img/1oz8K5m7ve-713.webp 713w&quot;&gt;&lt;img alt=&quot;Microbenchmarks testing the performance of creating various `Intl` objects&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://www.recompiled.dev/img/1oz8K5m7ve-713.svg&quot; width=&quot;713&quot; height=&quot;371&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;p&gt;Note that for better performance, it’s recommended to explicitly create &lt;em&gt;and reuse&lt;/em&gt; an &lt;code&gt;Intl.NumberFormat&lt;/code&gt; or &lt;code&gt;Intl.DateTimeFormat&lt;/code&gt; or &lt;code&gt;Intl.Collator&lt;/code&gt; object, rather than calling methods like &lt;code&gt;toLocaleString&lt;/code&gt; or &lt;code&gt;localeCompare&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&quot;new-intl-features&quot; tabindex=&quot;-1&quot;&gt;New &lt;code&gt;Intl&lt;/code&gt; features &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/intl/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;All of this work has provided a great foundation to build new features on and we’re continuing to ship all the new Internationalization proposals that are in Stage 3.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://www.recompiled.dev/features/intl-relativetimeformat&quot;&gt;&lt;code&gt;Intl.RelativeTimeFormat&lt;/code&gt;&lt;/a&gt; has shipped in Chrome 71, &lt;a href=&quot;https://www.recompiled.dev/features/intl-listformat&quot;&gt;&lt;code&gt;Intl.ListFormat&lt;/code&gt;&lt;/a&gt; has shipped in Chrome 72, &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Locale&quot;&gt;&lt;code&gt;Intl.Locale&lt;/code&gt;&lt;/a&gt; has shipped in Chrome 74, and &lt;a href=&quot;https://github.com/tc39/proposal-intl-datetime-style&quot;&gt;&lt;code&gt;dateStyle&lt;/code&gt; and &lt;code&gt;timeStyle&lt;/code&gt; options for &lt;code&gt;Intl.DateTimeFormat&lt;/code&gt;&lt;/a&gt; and &lt;a href=&quot;https://github.com/tc39/ecma402/pull/236&quot;&gt;BigInt support for &lt;code&gt;Intl.DateTimeFormat&lt;/code&gt;&lt;/a&gt; are shipping in Chrome 76. &lt;a href=&quot;https://github.com/tc39/proposal-intl-DateTimeFormat-formatRange&quot;&gt;&lt;code&gt;Intl.DateTimeFormat#formatRange&lt;/code&gt;&lt;/a&gt;, &lt;a href=&quot;https://github.com/tc39/proposal-intl-segmenter/&quot;&gt;&lt;code&gt;Intl.Segmenter&lt;/code&gt;&lt;/a&gt;, and &lt;a href=&quot;https://github.com/tc39/proposal-unified-intl-numberformat/&quot;&gt;additional options for &lt;code&gt;Intl.NumberFormat&lt;/code&gt;&lt;/a&gt; are currently under development in V8, and we hope to ship them soon!&lt;/p&gt;
&lt;p&gt;Many of these new APIs, and others further down the pipeline, are due to our work on standardizing new features to help developers with internationalization. &lt;a href=&quot;https://github.com/tc39/proposal-intl-displaynames&quot;&gt;&lt;code&gt;Intl.DisplayNames&lt;/code&gt;&lt;/a&gt; is a Stage 1 proposal that allows users to localize the display names of language, region or script display names. &lt;a href=&quot;https://github.com/fabalbon/proposal-intl-DateTimeFormat-formatRange&quot;&gt;&lt;code&gt;Intl.DateTimeFormat#formatRange&lt;/code&gt;&lt;/a&gt; is a Stage 3 proposal that specifies a way to format date ranges in a concise and locale-aware manner. &lt;a href=&quot;https://github.com/tc39/proposal-unified-intl-numberformat&quot;&gt;The unified &lt;code&gt;Intl.NumberFormat&lt;/code&gt; API proposal&lt;/a&gt; is a Stage 3 proposal that improves &lt;code&gt;Intl.NumberFormat&lt;/code&gt; by adding support for measurement units, currency and sign display policies, and scientific and compact notation. You can get involved in the future of ECMA-402 as well, by contributing at &lt;a href=&quot;https://github.com/tc39/ecma402&quot;&gt;its GitHub repository&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot; tabindex=&quot;-1&quot;&gt;Conclusion &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/intl/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;Intl&lt;/code&gt; provides a feature-rich API for several operations needed in internationalizing your web app, leaving the heavy lifting to the browser, without shipping as much data or code over the wire. Thinking through the proper use of these APIs can lead your UI to work better in different locales. Due to the work by the Google V8 and i18n teams in collaboration with TC39 and its ECMA-402 subgroup, you can now access more functionality with better performance, and expect further improvements over time.&lt;/p&gt;
</content>
	</entry>
	
	<entry>
		<title>Optimizing hash tables in V8</title>
		<link href="https://www.recompiled.dev/blog/hash-code/"/>
		<updated>2018-01-29T13:33:37Z</updated>
		<id>https://www.recompiled.dev/blog/hash-code/</id>
		<content type="html">&lt;div class=&quot;message-box&quot;&gt;
	&lt;p&gt;&lt;em&gt;This post was originally published on the &lt;a href=&quot;https://v8.dev/blog/hash-code&quot;&gt;V8 blog&lt;/a&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;ECMAScript 2015 introduced several new data structures such as Map, Set, WeakSet, and WeakMap, all of which use hash tables under the hood. This post details the &lt;a href=&quot;https://bugs.chromium.org/p/v8/issues/detail?id=6404&quot;&gt;recent improvements&lt;/a&gt; in how &lt;a href=&quot;https://www.recompiled.dev/blog/v8-release-63&quot;&gt;V8 v6.3+&lt;/a&gt; stores the keys in hash tables.&lt;/p&gt;
&lt;h2 id=&quot;hash-code&quot; tabindex=&quot;-1&quot;&gt;Hash code &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/hash-code/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;A &lt;a href=&quot;https://en.wikipedia.org/wiki/Hash_function&quot;&gt;&lt;em&gt;hash function&lt;/em&gt;&lt;/a&gt; is used to map a given key to a location in the hash table. A &lt;em&gt;hash code&lt;/em&gt; is the result of running this hash function over a given key.&lt;/p&gt;
&lt;p&gt;In V8, the hash code is just a random number, independent of the object value. Therefore, we can’t recompute it, meaning we must store it.&lt;/p&gt;
&lt;p&gt;For JavaScript objects that were used as keys, previously, the hash code was stored as a private symbol on the object. A private symbol in V8 is similar to a &lt;a href=&quot;https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol&quot;&gt;&lt;code&gt;Symbol&lt;/code&gt;&lt;/a&gt;, except that it’s not enumerable and doesn’t leak to userspace JavaScript.&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;GetObjectHash&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token parameter&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; hash &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; key&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;hashCodeSymbol&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token constant&quot;&gt;IS_UNDEFINED&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hash&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
		hash &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;MathRandom&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0x40000000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		&lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hash &lt;span class=&quot;token operator&quot;&gt;===&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; hash &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
		key&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;hashCodeSymbol&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; hash&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
	&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; hash&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;This worked well because we didn’t have to reserve memory for a hash code field until the object was added to a hash table, at which point a new private symbol was stored on the object.&lt;/p&gt;
&lt;p&gt;V8 could also optimize the hash code symbol lookup just like any other property lookup using the IC system, providing very fast lookups for the hash code. This works well for &lt;a href=&quot;https://en.wikipedia.org/wiki/Inline_caching#Monomorphic_inline_caching&quot;&gt;monomorphic IC lookups&lt;/a&gt;, when the keys have the same &lt;a href=&quot;https://www.recompiled.dev/&quot;&gt;hidden class&lt;/a&gt;. However, most real-world code doesn’t follow this pattern, and often keys have different hidden classes, leading to slow &lt;a href=&quot;https://en.wikipedia.org/wiki/Inline_caching#Megamorphic_inline_caching&quot;&gt;megamorphic IC lookups&lt;/a&gt; of the hash code.&lt;/p&gt;
&lt;p&gt;Another problem with the private symbol approach was that it triggered a &lt;a href=&quot;https://www.recompiled.dev/#fast-property-access&quot;&gt;hidden class transition&lt;/a&gt; in the key on storing the hash code. This resulted in poor polymorphic code not just for the hash code lookup but also for other property lookups on the key and &lt;a href=&quot;https://floitsch.blogspot.com/2012/03/optimizing-for-v8-inlining.html&quot;&gt;deoptimization&lt;/a&gt; from optimized code.&lt;/p&gt;
&lt;h2 id=&quot;javascript-object-backing-stores&quot; tabindex=&quot;-1&quot;&gt;JavaScript object backing stores &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/hash-code/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;A JavaScript object (&lt;code&gt;JSObject&lt;/code&gt;) in V8 uses two words (apart from its header): one word for storing a pointer to the elements backing store, and another word for storing a pointer to the properties backing store.&lt;/p&gt;
&lt;p&gt;The elements backing store is used for storing properties that look like &lt;a href=&quot;https://tc39.es/ecma262/#sec-array-index&quot;&gt;array indices&lt;/a&gt;, whereas the properties backing store is used for storing properties whose keys are strings or symbols. See this &lt;a href=&quot;https://www.recompiled.dev/blog/fast-properties&quot;&gt;V8 blog post&lt;/a&gt; by Camillo Bruni for more information about these backing stores.&lt;/p&gt;
&lt;pre class=&quot;language-js&quot; tabindex=&quot;0&quot;&gt;&lt;code class=&quot;language-js&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
x&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;bar&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// ← stored in elements&lt;/span&gt;
x&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;foo&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;bar&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token comment&quot;&gt;// ← stored in properties&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;h2 id=&quot;hiding-the-hash-code&quot; tabindex=&quot;-1&quot;&gt;Hiding the hash code &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/hash-code/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The easiest solution to storing the hash code would be to extend the size of a JavaScript object by one word and store the hash code directly on the object. However, this would waste memory for objects that aren’t added to a hash table. Instead, we could try to store the hash code in the elements store or properties store.&lt;/p&gt;
&lt;p&gt;The elements backing store is an array containing its length and all the elements. There’s not much to be done here, as storing the hashcode in a reserved slot (like the 0th index) would still waste memory when we don’t use the object as a key in a hash table.&lt;/p&gt;
&lt;p&gt;Let’s look at the properties backing store. There are two kinds of data structures used as a properties backing store: arrays and dictionaries.&lt;/p&gt;
&lt;p&gt;Unlike the array used in the elements backing store which does not have an upper limit, the array used in the properties backing store has an upper limit of 1022 values. V8 transitions to using a dictionary on exceeding this limit for performance reasons. (I’m slightly simplifying this — V8 can also use a dictionary in other cases, but there is a fixed upper limit on the number of values that can be stored in the array.)&lt;/p&gt;
&lt;p&gt;So, there are three possible states for the properties backing store:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;empty (no properties)&lt;/li&gt;
&lt;li&gt;array (can store up to 1022 values)&lt;/li&gt;
&lt;li&gt;dictionary&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Let’s discuss each of these.&lt;/p&gt;
&lt;h3 id=&quot;the-properties-backing-store-is-empty&quot; tabindex=&quot;-1&quot;&gt;The properties backing store is empty &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/hash-code/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;For the empty case, we can directly store the hash code in this offset on the &lt;code&gt;JSObject&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://www.recompiled.dev/img/wAsJyBpUBW-323.avif 323w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://www.recompiled.dev/img/wAsJyBpUBW-323.webp 323w&quot;&gt;&lt;img alt=&quot;a graph&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://www.recompiled.dev/img/wAsJyBpUBW-323.png&quot; width=&quot;323&quot; height=&quot;160&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;h3 id=&quot;the-properties-backing-store-is-an-array&quot; tabindex=&quot;-1&quot;&gt;The properties backing store is an array &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/hash-code/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;V8 represents integers less than 2&lt;sup&gt;31&lt;/sup&gt; (on 32-bit systems) unboxed, as &lt;a href=&quot;https://wingolog.org/archives/2011/05/18/value-representation-in-javascript-implementations&quot;&gt;Smi&lt;/a&gt;s. In a Smi, the least significant bit is a tag used to distinguish it from pointers, while the remaining 31 bits hold the actual integer value.&lt;/p&gt;
&lt;p&gt;Normally, arrays store their length as a Smi. Since we know that the maximum capacity of this array is only 1022, we only need 10 bits to store the length. We can use the remaining 21 bits to store the hash code!&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://www.recompiled.dev/img/DSYtSz1nW7-491.avif 491w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://www.recompiled.dev/img/DSYtSz1nW7-491.webp 491w&quot;&gt;&lt;img alt=&quot;a graph&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://www.recompiled.dev/img/DSYtSz1nW7-491.png&quot; width=&quot;491&quot; height=&quot;322&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;h3 id=&quot;the-properties-backing-store-is-a-dictionary&quot; tabindex=&quot;-1&quot;&gt;The properties backing store is a dictionary &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/hash-code/&quot;&gt;#&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;For the dictionary case, we increase the dictionary size by 1 word to store the hashcode in a dedicated slot at the beginning of the dictionary. We get away with potentially wasting a word of memory in this case, because the proportional increase in size isn’t as big as in the array case.&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://www.recompiled.dev/img/YDT1jhWCfY-446.avif 446w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://www.recompiled.dev/img/YDT1jhWCfY-446.webp 446w&quot;&gt;&lt;img alt=&quot;a graph&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://www.recompiled.dev/img/YDT1jhWCfY-446.png&quot; width=&quot;446&quot; height=&quot;214&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;p&gt;With these changes, the hash code lookup no longer has to go through the complex JavaScript property lookup machinery.&lt;/p&gt;
&lt;h2 id=&quot;performance-improvements&quot; tabindex=&quot;-1&quot;&gt;Performance improvements &lt;a class=&quot;header-anchor&quot; href=&quot;https://www.recompiled.dev/blog/hash-code/&quot;&gt;#&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The &lt;a href=&quot;https://github.com/kpdecker/six-speed&quot;&gt;SixSpeed&lt;/a&gt; benchmark tracks the performance of Map and Set, and these changes resulted in a ~500% improvement.&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://www.recompiled.dev/img/wEfBvRvGlO-1999.avif 1999w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://www.recompiled.dev/img/wEfBvRvGlO-1999.webp 1999w&quot;&gt;&lt;img alt=&quot;a graph&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://www.recompiled.dev/img/wEfBvRvGlO-1999.png&quot; width=&quot;1999&quot; height=&quot;386&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;p&gt;This change caused a 5% improvement on the Basic benchmark in &lt;a href=&quot;https://webkit.org/blog/7536/jsc-loves-es6/&quot;&gt;ARES6&lt;/a&gt; as well.&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://www.recompiled.dev/img/hskYCYhgJ4-1999.avif 1999w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://www.recompiled.dev/img/hskYCYhgJ4-1999.webp 1999w&quot;&gt;&lt;img alt=&quot;a graph&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://www.recompiled.dev/img/hskYCYhgJ4-1999.png&quot; width=&quot;1999&quot; height=&quot;505&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
&lt;p&gt;This also resulted in an 18% improvement in one of the benchmarks in the &lt;a href=&quot;http://emberperf.eviltrout.com/&quot;&gt;Emberperf&lt;/a&gt; benchmark suite that tests Ember.js.&lt;/p&gt;
&lt;p&gt;&lt;picture&gt;&lt;source type=&quot;image/avif&quot; srcset=&quot;https://www.recompiled.dev/img/KpLBt1XS4c-1987.avif 1987w&quot;&gt;&lt;source type=&quot;image/webp&quot; srcset=&quot;https://www.recompiled.dev/img/KpLBt1XS4c-1987.webp 1987w&quot;&gt;&lt;img alt=&quot;a graph&quot; loading=&quot;lazy&quot; decoding=&quot;async&quot; src=&quot;https://www.recompiled.dev/img/KpLBt1XS4c-1987.jpeg&quot; width=&quot;1987&quot; height=&quot;609&quot;&gt;&lt;/picture&gt;&lt;/p&gt;
</content>
	</entry>
</feed>
